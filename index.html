<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UK Locations Map - Rail Stations, Pret, Sainsbury's & TfL</title>
    <script src='https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.css' rel='stylesheet' />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }
        
        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }
        
        .map-overlay {
            position: absolute;
            top: 20px;
            right: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            padding: 15px;
            max-width: 280px;
            z-index: 1;
        }
        
        .map-overlay h3 {
            margin-bottom: 15px;
            font-size: 18px;
            color: #333;
        }
        
        .layer-toggle {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            cursor: pointer;
            padding: 8px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        
        .layer-toggle:hover {
            background-color: #f5f5f5;
        }
        
        .layer-toggle input[type="checkbox"] {
            margin-right: 10px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .layer-toggle label {
            display: flex;
            align-items: center;
            cursor: pointer;
            flex: 1;
        }
        
        .marker-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 8px;
            border: 2px solid white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        
        .marker-icon.rail { background-color: #E63946; }
        .marker-icon.pret { background-color: #F77F00; }
        .marker-icon.sainsburys { background-color: #06AED5; }
        .marker-icon.tfl { background-color: #7209B7; }
        
        .stats {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
            font-size: 13px;
            color: #666;
        }
        
        .stats-item {
            margin-bottom: 5px;
        }
        
        .mapboxgl-popup-content {
            padding: 15px;
            max-width: 280px;
        }
        
        .popup-title {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 8px;
            color: #333;
        }
        
        .popup-detail {
            font-size: 13px;
            color: #666;
            margin-bottom: 4px;
        }
        
        .popup-brand {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 8px;
        }
        
        .popup-brand.rail { background-color: #E63946; color: white; }
        .popup-brand.pret { background-color: #F77F00; color: white; }
        .popup-brand.sainsburys { background-color: #06AED5; color: white; }
        .popup-brand.tfl { background-color: #7209B7; color: white; }
        
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px 40px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 2;
            font-size: 16px;
            color: #333;
        }
        
        @media (max-width: 768px) {
            .map-overlay {
                top: 10px;
                right: 10px;
                left: 10px;
                max-width: none;
            }
        }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <div id="loading" class="loading">Loading map data...</div>
    
    <div class="map-overlay">
        <h3>Map Layers</h3>
        
        <div class="layer-toggle">
            <input type="checkbox" id="toggle-rail" checked>
            <label for="toggle-rail">
                <span class="marker-icon rail"></span>
                <span>National Rail Stations</span>
            </label>
        </div>
        
        <div class="layer-toggle">
            <input type="checkbox" id="toggle-pret" checked>
            <label for="toggle-pret">
                <span class="marker-icon pret"></span>
                <span>Pret A Manger</span>
            </label>
        </div>
        
        <div class="layer-toggle">
            <input type="checkbox" id="toggle-sainsburys" checked>
            <label for="toggle-sainsburys">
                <span class="marker-icon sainsburys"></span>
                <span>Sainsbury's</span>
            </label>
        </div>
        
        <div class="layer-toggle">
            <input type="checkbox" id="toggle-tfl" checked>
            <label for="toggle-tfl">
                <span class="marker-icon tfl"></span>
                <span>TfL Stations</span>
            </label>
        </div>
        
        <div class="stats">
            <div class="stats-item"><strong>Total Locations:</strong> <span id="total-count">0</span></div>
            <div class="stats-item"><strong>Visible:</strong> <span id="visible-count">0</span></div>
        </div>
    </div>

    <script src="data/national-rail-stations.js"></script>
    <script src="data/tfl-stations.js"></script>
    <script>
        let pretLocations = [];
        let sainsburysLocations = [];
        
        Promise.all([
            fetch('data/pret-locations.json').then(r => r.json()),
            fetch('data/sainsburys-locations.json').then(r => r.json())
        ]).then(([pret, sainsburys]) => {
            pretLocations = pret;
            sainsburysLocations = sainsburys;
            initializeMap();
        }).catch(err => {
            console.error('Error loading data:', err);
            document.getElementById('loading').textContent = 'Error loading data. Please refresh the page.';
        });
        
        function initializeMap() {
            mapboxgl.accessToken = 'YOUR_MAPBOX_ACCESS_TOKEN';
            
            if (mapboxgl.accessToken === 'YOUR_MAPBOX_ACCESS_TOKEN') {
                document.getElementById('loading').innerHTML = `
                    <div style="max-width: 500px;">
                        <h3 style="margin-bottom: 15px; color: #E63946;">⚠️ Mapbox Token Required</h3>
                        <p style="margin-bottom: 10px;">To display the map, you need a free Mapbox access token.</p>
                        <p style="margin-bottom: 10px;"><strong>Quick steps:</strong></p>
                        <ol style="text-align: left; margin-left: 20px; margin-bottom: 15px;">
                            <li>Go to <a href="https://www.mapbox.com/" target="_blank" style="color: #06AED5;">mapbox.com</a></li>
                            <li>Create a free account (no credit card needed)</li>
                            <li>Copy your default public token (starts with pk.)</li>
                            <li>Replace 'YOUR_MAPBOX_ACCESS_TOKEN' in index.html (line 222)</li>
                            <li>Refresh this page</li>
                        </ol>
                        <p style="font-size: 13px; color: #666;">See MAPBOX_TOKEN_INSTRUCTIONS.md for detailed instructions.</p>
                    </div>
                `;
                return;
            }
            
            const map = new mapboxgl.Map({
                container: 'map',
                style: 'mapbox://styles/mapbox/light-v11',
                center: [-0.1276, 51.5074],
                zoom: 10
            });
            
            map.on('load', () => {
                document.getElementById('loading').style.display = 'none';
                
                addMarkersToMap(map, nationalRailStations, 'rail', '#E63946');
                addMarkersToMap(map, pretLocations, 'pret', '#F77F00');
                addMarkersToMap(map, sainsburysLocations, 'sainsburys', '#06AED5');
                addMarkersToMap(map, tflStations, 'tfl', '#7209B7');
                
                updateStats();
                
                setupLayerToggles(map);
            });
            
            map.addControl(new mapboxgl.NavigationControl());
            map.addControl(new mapboxgl.FullscreenControl());
        }
        
        function addMarkersToMap(map, locations, brand, color) {
            const geojson = {
                type: 'FeatureCollection',
                features: locations.map(loc => ({
                    type: 'Feature',
                    properties: {
                        ...loc,
                        brand: brand
                    },
                    geometry: {
                        type: 'Point',
                        coordinates: [loc.longitude, loc.latitude]
                    }
                }))
            };
            
            map.addSource(`${brand}-source`, {
                type: 'geojson',
                data: geojson,
                cluster: true,
                clusterMaxZoom: 14,
                clusterRadius: 50
            });
            
            map.addLayer({
                id: `${brand}-clusters`,
                type: 'circle',
                source: `${brand}-source`,
                filter: ['has', 'point_count'],
                paint: {
                    'circle-color': color,
                    'circle-radius': [
                        'step',
                        ['get', 'point_count'],
                        15, 10,
                        20, 50,
                        25, 100,
                        30
                    ],
                    'circle-opacity': 0.8
                }
            });
            
            map.addLayer({
                id: `${brand}-cluster-count`,
                type: 'symbol',
                source: `${brand}-source`,
                filter: ['has', 'point_count'],
                layout: {
                    'text-field': '{point_count_abbreviated}',
                    'text-font': ['DIN Offc Pro Medium', 'Arial Unicode MS Bold'],
                    'text-size': 12
                },
                paint: {
                    'text-color': '#ffffff'
                }
            });
            
            map.addLayer({
                id: `${brand}-points`,
                type: 'circle',
                source: `${brand}-source`,
                filter: ['!', ['has', 'point_count']],
                paint: {
                    'circle-color': color,
                    'circle-radius': 6,
                    'circle-stroke-width': 2,
                    'circle-stroke-color': '#ffffff'
                }
            });
            
            map.on('click', `${brand}-clusters`, (e) => {
                const features = map.queryRenderedFeatures(e.point, {
                    layers: [`${brand}-clusters`]
                });
                const clusterId = features[0].properties.cluster_id;
                map.getSource(`${brand}-source`).getClusterExpansionZoom(
                    clusterId,
                    (err, zoom) => {
                        if (err) return;
                        map.easeTo({
                            center: features[0].geometry.coordinates,
                            zoom: zoom
                        });
                    }
                );
            });
            
            map.on('click', `${brand}-points`, (e) => {
                const coordinates = e.features[0].geometry.coordinates.slice();
                const props = e.features[0].properties;
                
                let popupContent = `
                    <div class="popup-brand ${brand}">${getBrandName(brand)}</div>
                    <div class="popup-title">${props.name}</div>
                `;
                
                if (props.address) {
                    popupContent += `<div class="popup-detail"><strong>Address:</strong> ${props.address}</div>`;
                }
                if (props.city) {
                    popupContent += `<div class="popup-detail"><strong>City:</strong> ${props.city}</div>`;
                }
                if (props.postcode) {
                    popupContent += `<div class="popup-detail"><strong>Postcode:</strong> ${props.postcode}</div>`;
                }
                if (props.openingHours) {
                    popupContent += `<div class="popup-detail"><strong>Hours:</strong> ${props.openingHours}</div>`;
                }
                if (props.phone) {
                    popupContent += `<div class="popup-detail"><strong>Phone:</strong> ${props.phone}</div>`;
                }
                if (props.crsCode) {
                    popupContent += `<div class="popup-detail"><strong>CRS Code:</strong> ${props.crsCode}</div>`;
                }
                if (props.modes) {
                    try {
                        const modes = JSON.parse(props.modes);
                        popupContent += `<div class="popup-detail"><strong>Modes:</strong> ${modes.join(', ')}</div>`;
                    } catch (e) {
                        if (props.modes) {
                            popupContent += `<div class="popup-detail"><strong>Modes:</strong> ${props.modes}</div>`;
                        }
                    }
                }
                
                while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
                    coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
                }
                
                new mapboxgl.Popup()
                    .setLngLat(coordinates)
                    .setHTML(popupContent)
                    .addTo(map);
            });
            
            map.on('mouseenter', `${brand}-clusters`, () => {
                map.getCanvas().style.cursor = 'pointer';
            });
            map.on('mouseleave', `${brand}-clusters`, () => {
                map.getCanvas().style.cursor = '';
            });
            map.on('mouseenter', `${brand}-points`, () => {
                map.getCanvas().style.cursor = 'pointer';
            });
            map.on('mouseleave', `${brand}-points`, () => {
                map.getCanvas().style.cursor = '';
            });
        }
        
        function getBrandName(brand) {
            const names = {
                'rail': 'National Rail',
                'pret': 'Pret A Manger',
                'sainsburys': "Sainsbury's",
                'tfl': 'TfL Station'
            };
            return names[brand] || brand;
        }
        
        function setupLayerToggles(map) {
            const toggles = {
                'rail': document.getElementById('toggle-rail'),
                'pret': document.getElementById('toggle-pret'),
                'sainsburys': document.getElementById('toggle-sainsburys'),
                'tfl': document.getElementById('toggle-tfl')
            };
            
            Object.keys(toggles).forEach(brand => {
                toggles[brand].addEventListener('change', (e) => {
                    const visibility = e.target.checked ? 'visible' : 'none';
                    map.setLayoutProperty(`${brand}-clusters`, 'visibility', visibility);
                    map.setLayoutProperty(`${brand}-cluster-count`, 'visibility', visibility);
                    map.setLayoutProperty(`${brand}-points`, 'visibility', visibility);
                    updateStats();
                });
            });
        }
        
        function updateStats() {
            const total = nationalRailStations.length + pretLocations.length + 
                         sainsburysLocations.length + tflStations.length;
            
            let visible = 0;
            if (document.getElementById('toggle-rail').checked) visible += nationalRailStations.length;
            if (document.getElementById('toggle-pret').checked) visible += pretLocations.length;
            if (document.getElementById('toggle-sainsburys').checked) visible += sainsburysLocations.length;
            if (document.getElementById('toggle-tfl').checked) visible += tflStations.length;
            
            document.getElementById('total-count').textContent = total.toLocaleString();
            document.getElementById('visible-count').textContent = visible.toLocaleString();
        }
    </script>
</body>
</html>
